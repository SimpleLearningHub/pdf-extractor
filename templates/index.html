<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Image Extractor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a1929;
            /* Dark Blue */
            --surface-color: #132f4c;
            --primary-color: #66b2ff;
            --secondary-color: #50e3c2;
            --text-color: #e0f2f1;
            --text-secondary: #b0bec5;
            --error-color: #ff5252;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* Sidebar / Upload Area */
        .sidebar {
            width: 400px;
            background-color: var(--surface-color);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #102a43;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        h1 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 2px dashed #486581;
            border-radius: 12px;
            padding: 3rem 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(102, 178, 255, 0.05);
        }

        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: block;
        }

        .upload-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .btn-extract {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            width: 100%;
        }

        .btn-extract:hover {
            background-color: #3399ff;
            transform: translateY(-2px);
        }

        .flash-messages {
            margin-top: 2rem;
        }

        .flash-message {
            background-color: rgba(80, 227, 194, 0.1);
            border-left: 4px solid var(--secondary-color);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        /* Main Content / Gallery */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: var(--bg-color);
        }

        .gallery-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gallery-title {
            font-size: 1.25rem;
            color: var(--text-color);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1.5rem;
        }

        .image-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
            padding-bottom: 100%;
            /* 1:1 Aspect Ratio container */
        }

        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .image-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80%;
            color: var(--text-secondary);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            padding: 2rem;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--primary-color);
        }

        .modal-caption {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Checkbox & Delete Styles */
        .select-all-container {
            color: var(--text-color);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .btn-delete {
            background-color: var(--error-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #555;
        }

        .image-checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        /* LLM Config Styles */
        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid #333;
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-extract-text {
            background-color: var(--secondary-color);
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-extract-text:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-download {
            background-color: #333;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .btn-download:hover {
            background-color: #555;
        }

        /* Modal Navigation */
        .prev,
        .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -50px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            -webkit-user-select: none;
            z-index: 1001;
            /* Above image */
        }

        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }

        .prev {
            left: 0;
            border-radius: 0 3px 3px 0;
        }

        .prev:hover,
        .next:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="sidebar">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                PDF Extractor
            </h1>

            <form action="/" method="post" enctype="multipart/form-data" id="uploadForm">
                <div class="upload-area" id="dropZone">
                    <input type="file" name="file" accept=".pdf" required id="fileInput">
                    <span class="upload-icon">üìÑ</span>
                    <p class="upload-text">Drag PDF here or click to browse</p>
                    <p id="fileName" style="margin-top: 10px; color: var(--primary-color); font-weight: 500; font-size: 0.8rem;"></p>
                </div>
                <button type="submit" class="btn-extract">Extract Images</button>
            </form>

            <div class="llm-config" style="margin-top: 2rem; border-top: 1px solid #333; padding-top: 1rem;">
                <h3 style="color: var(--primary-color); font-size: 1.1rem; margin-bottom: 1rem;">Text Extraction</h3>
                <div class="input-group">
                    <label>Gemini API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter API Key" value="{{ session.get('api_key', '') }}">
                </div>
                <div class="input-group">
                    <label>Model Code</label>
                    <input type="text" id="modelInput" placeholder="e.g., gemini-1.5-flash" value="{{ session.get('model', 'gemini-1.5-flash') }}">
                </div>
                <div class="input-group">
                    <label>Prompt</label>
                    <textarea id="promptText" rows="3" placeholder="e.g., Extract all text from this image">{{ session.get('prompt', '') }}</textarea>
                </div>
            </div>

            <div id="progressContainer" style="display: none; margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span id="progressStatus" style="color: var(--text-color); font-size: 0.9rem;">Extracting...</span>
                    <span id="progressPercent" style="color: var(--primary-color); font-weight: bold; font-size: 0.9rem;">0%</span>
                </div>
                <div style="width: 100%; height: 8px; background-color: #333; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background-color: var(--secondary-color); transition: width 0.3s ease;"></div>
                </div>
            </div>

            <div class="flash-messages">
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                {% for message in messages %}
                <div class="flash-message">{{ message }}</div>
                {% endfor %}
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <div class="main-content">
            <form action="/delete" method="POST" id="mainForm">
                <div class="gallery-header">
                    <div class="gallery-title">Extracted Images</div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        {% if images %}
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">{{ images|length }} images found</div>
                        <label class="select-all-container">
                            <input type="checkbox" id="selectAll"> Select All
                        </label>

                        <button type="button" class="btn-extract-text" id="extractBtn" onclick="submitExtraction()" disabled>Extract Text</button>
                        <button type="submit" class="btn-delete" id="deleteBtn" disabled>Delete Selected</button>

                        {% if has_merged %}
                        <a href="/download_merged" class="btn-download" title="Download Merged Text">‚¨áÔ∏è</a>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                {% if images %}
                <div class="gallery-grid">
                    {% for image in images %}
                    <div class="image-card">
                        <input type="checkbox" name="images" value="{{ image }}" class="image-checkbox" onclick="event.stopPropagation(); updateDeleteButton();">
                        <div class="img-wrapper" data-src="{{ url_for('static', filename='extracted_image/' + image) }}" data-name="{{ image }}" onclick="openModal(this.dataset.src, this.dataset.name)">
                            <img src="{{ url_for('static', filename='extracted_image/' + image) }}" alt="{{ image }}" loading="lazy">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üñºÔ∏è</div>
                    <h3>No images to display</h3>
                    <p>Upload a PDF to see extracted images here.</p>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <a class="prev" onclick="changeImage(-1, event)">&#10094;</a>
        <a class="next" onclick="changeImage(1, event)">&#10095;</a>
        <img class="modal-content" id="modalImg">
        <div class="modal-caption" id="caption"></div>
    </div>

    <script>
        // Checkbox Logic
        const selectAllCheckbox = document.getElementById('selectAll');
        const imageCheckboxes = document.querySelectorAll('.image-checkbox');
        const deleteBtn = document.getElementById('deleteBtn');
        const extractBtn = document.getElementById('extractBtn');

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                const isChecked = this.checked;
                imageCheckboxes.forEach(cb => cb.checked = isChecked);
                updateButtons();
            });
        }

        function updateButtons() {
            const anyChecked = Array.from(imageCheckboxes).some(cb => cb.checked);
            if (deleteBtn) deleteBtn.disabled = !anyChecked;
            if (extractBtn) extractBtn.disabled = !anyChecked;

            if (selectAllCheckbox) {
                const allChecked = Array.from(imageCheckboxes).every(cb => cb.checked) && imageCheckboxes.length > 0;
                selectAllCheckbox.checked = allChecked;
            }
        }

        // Use updateButtons instead of updateDeleteButton in onclicks
        // We will need to update the onclick handlers in the HTML too or just alias it
        window.updateDeleteButton = updateButtons;

        async function submitExtraction() {
            const apiKey = document.getElementById('apiKey').value;
            const prompt = document.getElementById('promptText').value;
            const model = document.getElementById('modelInput').value;
            const extractBtn = document.getElementById('extractBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const progressPercent = document.getElementById('progressPercent');

            if (!apiKey || !prompt) {
                alert("Please enter both API Key and Prompt.");
                return;
            }

            // UI Reset
            extractBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressStatus.textContent = 'Starting extraction...';

            // Gather selected images
            const imageCheckboxes = document.querySelectorAll('.image-checkbox:checked');
            const formData = new FormData();
            formData.append('api_key', apiKey);
            formData.append('prompt', prompt);
            formData.append('model', model);
            imageCheckboxes.forEach(cb => formData.append('images', cb.value));

            try {
                const response = await fetch('/extract_text', {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            if (data.error) {
                                progressStatus.textContent = data.error;
                                progressStatus.style.color = 'var(--error-color)';
                            } else {
                                if (data.status) progressStatus.textContent = data.status;
                                if (data.progress !== undefined && data.total !== undefined) {
                                    const percent = Math.round((data.progress / data.total) * 100);
                                    progressBar.style.width = percent + '%';
                                    progressPercent.textContent = percent + '%';
                                }
                                if (data.complete) {
                                    // Refresh to show download button and update state
                                    setTimeout(() => window.location.reload(), 1000);
                                }
                            }
                        } catch (e) {
                            console.error("Error parsing JSON chunk", e);
                        }
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                progressStatus.textContent = "Network error occurred.";
                extractBtn.disabled = false; // Changed from actionsBtn to extractBtn
            }
        }

        // Drag and Drop Visuals
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dropZone.classList.remove('dragover');
        }

        fileInput.addEventListener('change', function () {
            if (this.files && this.files.length > 0) {
                fileNameDisplay.textContent = this.files[0].name;
                document.querySelector('.upload-text').style.display = 'none';
            }
        });

        // Modal Logic
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImg");
        const captionText = document.getElementById("caption");

        let currentImageIndex = 0;
        let allImages = [];

        function updateImageList() {
            // Refresh list of images currently in the gallery
            const wrappers = document.querySelectorAll('.img-wrapper');
            allImages = Array.from(wrappers).map(wrapper => ({
                src: wrapper.dataset.src,
                name: wrapper.dataset.name
            }));
        }

        function openModal(src, name) {
            updateImageList();
            // Find index of clicked image
            currentImageIndex = allImages.findIndex(img => img.name === name);
            if (currentImageIndex === -1) currentImageIndex = 0;

            modal.style.display = "flex";
            updateModalContent();
        }

        function updateModalContent() {
            if (allImages.length > 0) {
                const img = allImages[currentImageIndex];
                modalImg.src = img.src;
                captionText.innerHTML = img.name;
            }
        }

        function changeImage(n, event) {
            if (event) event.stopPropagation(); // Prevent modal from closing

            currentImageIndex += n;

            // Wrap around
            if (currentImageIndex >= allImages.length) {
                currentImageIndex = 0;
            } else if (currentImageIndex < 0) {
                currentImageIndex = allImages.length - 1;
            }

            updateModalContent();
        }

        function closeModal() {
            modal.style.display = "none";
        }

        // Close on Escape key and Navigate with Arrows
        document.addEventListener('keydown', function (event) {
            if (modal.style.display === "flex") {
                if (event.key === "Escape") {
                    closeModal();
                } else if (event.key === "ArrowLeft") {
                    changeImage(-1);
                } else if (event.key === "ArrowRight") {
                    changeImage(1);
                }
            }
        });
    </script>

</body>

</html>